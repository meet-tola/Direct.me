$(function(){var $modal=$("[data-access-view]");var $modalBack=$(".modalBack",$modal);var accessData=$modal.data();var accessUrl=accessData.accessUrl;var initialSlide=accessData.initialSlide;var viewFeatured=accessData.viewFeatured;var subId;console.log("555",viewFeatured);$(document).off("submit","form[data-access-step=checkout]");$(document).off("submit","form[data-access-step=personalize]");$(document).off("submit","form[data-access-step=login]");$(".avatarFeaturedOverlay").each(function(){var $this=$(this);setTimeout(function(){requestAnimationFrame(function(){$this.addClass("avatarFeaturedOverlayDone");});},2400);});$($modal).on("click",'a[data-toggle="slide"]',function(){var $this=$(this);var href=$this.attr("href");var activeSlideBack=$(href).attr("data-modal-back");setTimeout(function(){$modalBack.attr("href",activeSlideBack?activeSlideBack:initialSlide);},250);if(href!==initialSlide&&href!="#accessComplete"){$modalBack.show();}else{$modalBack.hide();}});$("[data-access-show-overlay]",$modal).click(function(e){e.preventDefault();$(".modalOverlayFeature").show();$("body").addClass("modalOpen");});var iti;var stripe;var cardNumber;var authPayment;var savedErrors={};var setupPayment=function(){stripe=Stripe(stripePublicKey);var elements=stripe.elements({fonts:[{cssSrc:"https://fonts.googleapis.com/css2?family=Poppins:ital,wght@0,400;0,500;0,600;0,700;1,400;1,500;1,600;1,700&display=swap",},],locale:"auto",});var elementStyles={base:{color:"#2d323f",fontSize:"14px",fontWeight:400,fontFamily:"Poppins, sans-serif",fontSmoothing:"antialiased",":focus":{color:"#2d323f",},"::placeholder":{color:"#8e8e8e",},},invalid:{color:"#ca0808",":focus":{color:"#ca0808",},"::placeholder":{color:"#ca0808",},},};cardNumber=elements.create("cardNumber",{style:elementStyles,showIcon:true,});cardNumber.mount("#cc_number");var cardExpiry=elements.create("cardExpiry",{style:elementStyles,});cardExpiry.mount("#cc_expiry");var cardCvc=elements.create("cardCvc",{style:elementStyles,});cardCvc.mount("#cc_cvc");[cardNumber,cardExpiry,cardCvc].forEach(function(element,idx){element.on("change",function(event){if(event.error){savedErrors[idx]=event.error.message;}else{delete savedErrors[idx];}});});authPayment=function(authData){return $.ajax(subId?"/stripe/subscribe":"/stripe/auth",{data:JSON.stringify({items:accessItemId,subscription_id:subId,interaction:window.accessInteractionId,...authData,}),contentType:"application/json",dataType:"json",type:"POST",processData:false,}).then(function(paymentData){if(paymentData.requiresAction){return handleAction(paymentData.clientSecret);}else if(paymentData.error){displayError(paymentData.error);}else{return true;}}).fail(function(error){displayError(error.responseText);});};var handleAction=function(clientSecret){return stripe.handleCardAction(clientSecret).then(function(data){if(data.error){displayError("Your card was not authenticated, please try again");}else if(data.paymentIntent.status==="requires_confirmation"){return authPayment({paymentIntentId:data.paymentIntent.id});}else{return true;}});};};var completeOrder=function(){return $.post(accessUrl+"?action=complete",function(result){if(result){location.href=result;}else{$("#accessSlideComplete").click();}});};window.accessSetupCheckout=function(){var requiresPayment=$("#cc_number",$modal).length;var phoneEl=$("#phone",$modal);if(phoneEl.length){if(iti){iti.destroy();}
var dropdownContainer=$("#iti-dropdown");if(!dropdownContainer.length){dropdownContainer=$('<div id="iti-dropdown"></div>').appendTo("body");}
iti=intlTelInput(phoneEl[0],{utilsScript:"/static/js/intlTelInput/utils.js",dropdownContainer:dropdownContainer[0],autoPlaceholder:"aggressive",nationalMode:true,});}
if(requiresPayment){if(typeof window.Stripe==="undefined"){var script=document.createElement("script");script.async=true;script.src="https://js.stripe.com/v3/";script.onload=setupPayment;document.head.appendChild(script);}else{setupPayment();}}
$(document).on("submit","form[data-access-step=checkout]",function(e){e.preventDefault();var $this=$(this);var $btns=$("button",$this).attr("disabled",true);var $btn=$('button[type="submit"]',$this).buttonLoading();var setupFuturePayments=$("input[name='setupFuturePayments']").is(":checked");var paymentMethodId=$("input[name='paymentMethodId']:checked").val();var error;var enableButtons=function(){$btn.buttonReset();$btns.attr("disabled",false);};var submitCheckout=function(){$.post(accessUrl+
"?action=checkout&interaction="+
window.accessInteractionId,$this.serialize()).done(function(data){subId=data.subscription_id;if(paymentMethodId){authPayment({paymentMethodId,setupFuturePayments}).then(function(result){if(result){return completeOrder();}else{enableButtons();}}).fail(function(){enableButtons();});}else{completeOrder();}}).fail(function(error){displayError(error.responseText);$this.closest(".modalBody").scrollTop(0);enableButtons();});};if(phoneEl.length){iti.getNumber();if(!iti.isValidNumber()){displayError("Please enter a valid phone number");enableButtons();return;}else{phoneEl.value=iti.getNumber();}}
if(requiresPayment&&!paymentMethodId){var zipCode=$("input[name=zip]",$this).val();if(zipCode.length===0){savedErrors.zip="ZIP Code is required";}else{delete savedErrors.zip;}
var error=Object.keys(savedErrors).sort().reduce(function(maybeFoundError,key){return maybeFoundError||savedErrors[key];},null);if(error){displayError(error);enableButtons();return;}
stripe.createPaymentMethod({type:"card",card:cardNumber,billing_details:{address:{postal_code:zipCode,},},}).then(function(result){if(result.error){displayError(result.error.message);enableButtons();}else{paymentMethodId=result.paymentMethod.id;submitCheckout();}});}else{submitCheckout();}});};if(initialSlide=="#accessCheckout"&&!viewFeatured){accessSetupCheckout();}
var $startForm=$("form[data-access-step=start]",$modal);var $startButton=$("button[type=submit]",$startForm);$("input[name=customPrice]",$startForm).on("change keyup blur",function(){var price=$(this).val();if(price>0){$startButton.html($startButton.data("text")+" for $"+price);}else{$startButton.html($startButton.data("text"));}});$(document).on("click","input[name=paymentMethodId]",function(){var val=$(this).val();if(val==""){$("#newPayment").slideDown();}else{$("#newPayment").slideUp();}});$startForm.on("submit",function(e){e.preventDefault();var $this=$(this);var $submit=$("button[type=submit]",$this);$submit.buttonLoading();$.post(accessUrl+"?action=start",$this.serialize(),function(data){if(data&&data.redirect){location.href=redirect;}else{if(data&&data.interactionId){interactionId=data.interactionId;}
$('a[data-toggle="slide"]',$this).click();}}).fail(function(error){displayError(error.responseText);}).always(function(){$submit.buttonReset();});});$("[data-access-reload]",$modal).click(function(e){e.preventDefault();var $this=$(this);$modal.modalLoading();$.get($this.attr("data-access-reload"),function(html){$modal.replaceWith(html).removeClass("isLoading");});});$(".updateAccessPrice").on("click",function(){var val=$(this).val();if(val=="custom"){$("#customPriceInputRow").slideDown();$("#accessCustomPrice").val("").focus();}else{$("#customPriceInputRow").slideUp();$("#accessCustomPrice").val(val);}});$(".updateAccessQuantity").on("click",function(){var val=$(this).val();if(val=="custom"){$("#quantityInputRow").slideDown();$("#accessQuantity").val("").focus();}else{$("#quantityInputRow").slideUp();$("#accessQuantity").val(val).trigger('change');}});$("#accessQuantity").on("change keyup blur",function(){var val=$(this).val();if(!val){return;}
var total=$("#quantityTotal");var currency=new Intl.NumberFormat('en-US',{style:'currency',currency:total.data('currency'),});$("#quantityTotal").html(currency.format(total.data('price')*val));});$(document).on("click","input[name=subscription]",function(){if($(this).is(":checked")){$("input[name=setupFuturePayments]").prop({checked:true,disabled:true,});}else{$("input[name=setupFuturePayments]").prop({disabled:false,});}});$(document).on("submit","form[data-access-step=personalize]",function(e){e.preventDefault();var $this=$(this);var $submit=$("button[type=submit]",$this);$submit.buttonLoading();$.post(accessUrl+"?action=personalize",$this.serialize(),function(data){if(data){location.href=data;}}).fail(function(error){displayError(error.responseText);$this.closest(".modalBody").scrollTop(0);}).always(function(){$('button[type="submit"]',$this).buttonReset();});return;});$(document).on("submit","form[data-access-step=login]",function(e){e.preventDefault();var $this=$(this);var $submit=$("button[type=submit]",$this);var $button=$("#paymentSubmit");$submit.buttonLoading();$.post(accessUrl+"?action=login",$this.serialize(),function(data){$button.show();$("#paymentForm").html(data);setupPayment();$("form[data-access-step]").attr("data-access-step","checkout");}).fail(function(error){displayError(error.responseText);$this.closest(".modalBody").scrollTop(0);}).always(function(){$('button[type="submit"]',$this).buttonReset();});return;});$("#setup_url").on("keyup",_debounce(function(){var post_url=$(this).val();$.post(origin+"/users/username",{url:post_url,},function(data){if(data.status==true){$("#url_error").hide();$("#url_success").show();}else{$("#url_success").hide();$("#url_error").show();}},"json");},250));$("#access_email").on("keyup",_debounce(function(){var email=$(this).val();var $email=$("#emailRow");var $login=$("#loginRow");var $payment=$("#ccForm");var $button=$("#paymentSubmit");if(!email.length){return;}
$.post("/users/email",{email,},function(data){if(data.status==true){$email.removeClass("success");$(".inputHelp",$email).hide();$login.hide();$payment.show();$button.show();$("#paymentFormTitle").html("Payment Details");$("form[data-access-step]").attr("data-access-step","checkout");}else{$email.addClass("success");$(".inputHelp",$email).show();$login.show();$payment.hide();$button.hide();$("#paymentFormTitle").html("Sign In");$("form[data-access-step]").attr("data-access-step","login");}},"json");},250));});